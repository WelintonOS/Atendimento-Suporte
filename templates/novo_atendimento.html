{% extends "base.html" %}

{% block title %}Novo Atendimento - Sistema de Atendimento HUBGEO{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-plus-circle"></i> Novo Atendimento
        </h1>
        <a href="{{ url_for('atendimentos') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-person-plus"></i> Informa√ß√µes do Atendimento
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('novo_atendimento') }}">
                        <div class="row">
                            <!-- Informa√ß√µes do Cliente -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-person"></i> Dados do Cliente
                                </h6>

                                <div class="mb-3">
                                    <label for="cliente_nome" class="form-label">
                                        Nome do Cliente <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="cliente_nome" name="cliente_nome" required
                                           placeholder="Digite o nome completo do cliente"
                                           value="{{ request.form.cliente_nome if request.form.cliente_nome }}">
                                </div>

                                <div class="mb-3">
                                    <label for="cliente_email" class="form-label">
                                        Email do Cliente
                                    </label>
                                    <input type="email" class="form-control" id="cliente_email" name="cliente_email"
                                           placeholder="cliente@email.com"
                                           value="{{ request.form.cliente_email if request.form.cliente_email }}">
                                </div>

                                <div class="mb-3">
                                    <label for="cliente_contato" class="form-label">
                                        Telefone/WhatsApp
                                    </label>
                                    <input type="text" class="form-control" id="cliente_contato" name="cliente_contato"
                                           placeholder="(11) 99999-9999"
                                           value="{{ request.form.cliente_contato if request.form.cliente_contato }}">
                                </div>

                                <div class="mb-3">
                                    <label for="forma_contato" class="form-label">
                                        Forma de Contato <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="forma_contato" name="forma_contato" required>
                                        <option value="">Selecione a forma de contato</option>
                                        <option value="Email" {% if request.form.forma_contato == 'Email' %}selected{% endif %}>
                                            üìß Email
                                        </option>
                                        <option value="WhatsApp" {% if request.form.forma_contato == 'WhatsApp' %}selected{% endif %}>
                                            üì± WhatsApp
                                        </option>
                                        <option value="Presencial" {% if request.form.forma_contato == 'Presencial' %}selected{% endif %}>
                                            üè¢ Presencial
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Informa√ß√µes do Atendimento -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-gear"></i> Dados do Atendimento
                                </h6>

                                <div class="mb-3">
                                    <label for="produto" class="form-label">
                                        Produto <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="produto" name="produto" required>
                                        <option value="">Selecione o produto</option>
                                        <option value="Acess√≥rios" {% if request.form.produto == 'Acess√≥rios' %}selected{% endif %}>Acess√≥rios</option>
                                        <option value="Controladoras" {% if request.form.produto == 'Controladoras' %}selected{% endif %}>Controladoras</option>
                                        <option value="Drones" {% if request.form.produto == 'Drones' %}selected{% endif %}>Drones</option>
                                        <option value="Esta√ß√£o Total" {% if request.form.produto == 'Esta√ß√£o Total' %}selected{% endif %}>Esta√ß√£o Total</option>
                                        <option value="GNSS" {% if request.form.produto == 'GNSS' %}selected{% endif %}>GNSS</option>
                                        <option value="N√≠vel" {% if request.form.produto == 'N√≠vel' %}selected{% endif %}>N√≠vel</option>
                                        <option value="R√°dio" {% if request.form.produto == 'R√°dio' %}selected{% endif %}>R√°dio</option>
                                        <option value="Software" {% if request.form.produto == 'Software' %}selected{% endif %}>Software</option>
                                        <option value="Teodolito" {% if request.form.produto == 'Teodolito' %}selected{% endif %}>Teodolito</option>
                                        <option value="Laser Scanner" {% if request.form.produto == 'Laser Scanner' %}selected{% endif %}>Laser Scanner</option>
                                        <option value="Outros" {% if request.form.produto == 'Outros' %}selected{% endif %}>Outros</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="marca" class="form-label">
                                        Marca
                                    </label>
                                    <select class="form-select" id="marca" name="marca">
                                        <option value="">Selecione a marca</option>
                                        <option value="Autel" {% if request.form.marca == 'Autel' %}selected{% endif %}>Autel</option>
                                        <option value="CHCNAV" {% if request.form.marca == 'CHCNAV' %}selected{% endif %}>CHCNAV</option>
                                        <option value="DJI" {% if request.form.marca == 'DJI' %}selected{% endif %}>DJI</option>
                                        <option value="Emlid" {% if request.form.marca == 'Emlid' %}selected{% endif %}>Emlid</option>
                                        <option value="Geomax" {% if request.form.marca == 'Geomax' %}selected{% endif %}>Geomax</option>
                                        <option value="Leica" {% if request.form.marca == 'Leica' %}selected{% endif %}>Leica</option>
                                        <option value="Sanding" {% if request.form.marca == 'Sanding' %}selected{% endif %}>Sanding</option>
                                        <option value="Matterport" {% if request.form.marca == 'Matterport' %}selected{% endif %}>Matterport</option>
                                        <option value="Outras" {% if request.form.marca == 'Outras' %}selected{% endif %}>Outras</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="problema" class="form-label">
                                        Descri√ß√£o do Problema <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="problema" name="problema" rows="8" required
                                              placeholder="Descreva detalhadamente o problema ou solicita√ß√£o do cliente...">{{ request.form.problema if request.form.problema }}</textarea>
                                </div>

                                <!-- Informa√ß√µes do Atendente -->
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Respons√°vel:</strong> {{ current_user.nome }}<br>
                                    <strong>Data/Hora:</strong> <span id="current-datetime"></span>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('atendimentos') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Criar Atendimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar com informa√ß√µes -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightbulb"></i> Dicas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-success">
                            <i class="bi bi-check-circle"></i> Informa√ß√µes Importantes
                        </h6>
                        <ul class="small">
                            <li>Preencha todos os campos obrigat√≥rios (*)</li>
                            <li>Seja detalhado na descri√ß√£o do problema</li>
                            <li>O atendimento ser√° registrado automaticamente</li>
                            <li>Voc√™ poder√° adicionar observa√ß√µes ao finalizar</li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-info">
                            <i class="bi bi-clock"></i> Tempo de Atendimento
                        </h6>
                        <p class="small">
                            O sistema registrar√° automaticamente o hor√°rio de in√≠cio
                            e fim do atendimento para controle de tempo.
                        </p>
                    </div>

                </div>
            </div>

            <!-- Estat√≠sticas r√°pidas -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-graph-up"></i> Estat√≠sticas Hoje
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="h4 mb-0 text-primary" id="atendimentos-hoje">-</div>
                                <small class="text-muted">Atendimentos</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="h4 mb-0 text-success" id="em-andamento">-</div>
                            <small class="text-muted">Em Andamento</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mostrar data/hora atual
function updateDateTime() {
    const now = new Date();
    const formatted = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    document.getElementById('current-datetime').textContent = formatted;
}
updateDateTime();
setInterval(updateDateTime, 1000);

// M√°scaras de input
document.getElementById('cliente_contato').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 10) {
        value = value.replace(/^(\d{2})(\d{4,5})(\d{4})$/, '($1) $2-$3');
    }
    e.target.value = value;
});

// Carregar estat√≠sticas do dia
fetch('/api/dashboard/stats')
    .then(response => response.json())
    .then(data => {
        document.getElementById('atendimentos-hoje').textContent = data.atendimentos_hoje;
        document.getElementById('em-andamento').textContent = data.em_andamento;
    })
    .catch(error => console.error('Erro ao carregar estat√≠sticas:', error));

// Valida√ß√£o do formul√°rio
document.querySelector('form').addEventListener('submit', function(e) {
    const nome = document.getElementById('cliente_nome').value.trim();
    const forma = document.getElementById('forma_contato').value;
    const produto = document.getElementById('produto').value;
    const problema = document.getElementById('problema').value.trim();

    if (!nome || !forma || !produto || !problema) {
        e.preventDefault();
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return false;
    }

    // Mostrar loading
    const btn = e.target.querySelector('button[type="submit"]');
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Criando...';
    btn.disabled = true;
});
</script>
{% endblock %}