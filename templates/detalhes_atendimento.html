{% extends "base.html" %}

{% block title %}Atendimento #{{ atendimento.id }} - Sistema de Atendimento HUBGEO{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-file-text"></i> Atendimento #{{ atendimento.id }}
        </h1>
        <div>
            <a href="{{ url_for('atendimentos') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            {% if atendimento.status == 'em_andamento' %}
                {% if atendimento.usuario_id == current_user.id %}
                <button type="button" class="btn btn-warning me-2" onclick="transferirAtendimento({{ atendimento.id }})">
                    <i class="bi bi-arrow-right-circle"></i> Transferir
                </button>
                <button type="button" class="btn btn-success" onclick="finalizarAtendimento({{ atendimento.id }})">
                    <i class="bi bi-check-circle"></i> Finalizar Atendimento
                </button>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Informa√ß√µes principais -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="bi bi-info-circle"></i> Informa√ß√µes do Atendimento
                        </h6>
                        <div>
                            {% if atendimento.status == 'em_andamento' %}
                                <span class="badge bg-warning fs-6">
                                    <i class="bi bi-clock"></i> Em Andamento
                                </span>
                            {% elif atendimento.status == 'concluido' %}
                                <span class="badge bg-success fs-6">
                                    <i class="bi bi-check-circle"></i> Conclu√≠do
                                </span>
                            {% elif atendimento.status == 'cancelado' %}
                                <span class="badge bg-danger fs-6">
                                    <i class="bi bi-x-circle"></i> Cancelado
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person"></i> Dados do Cliente
                            </h6>

                            <div class="mb-3">
                                <label class="form-label text-muted">Nome:</label>
                                <div class="fw-bold">{{ atendimento.cliente_nome }}</div>
                            </div>

                            {% if atendimento.cliente_email %}
                            <div class="mb-3">
                                <label class="form-label text-muted">Email:</label>
                                <div>
                                    <i class="bi bi-envelope text-primary"></i>
                                    <a href="mailto:{{ atendimento.cliente_email }}">{{ atendimento.cliente_email }}</a>
                                </div>
                            </div>
                            {% endif %}

                            {% if atendimento.cliente_contato %}
                            <div class="mb-3">
                                <label class="form-label text-muted">Contato:</label>
                                <div>
                                    <i class="bi bi-telephone text-success"></i>
                                    {{ atendimento.cliente_contato }}
                                </div>
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label class="form-label text-muted">Forma de Contato:</label>
                                <div>
                                    {% if atendimento.forma_contato == 'Email' %}
                                        <span class="badge bg-primary">üìß Email</span>
                                    {% elif atendimento.forma_contato == 'WhatsApp' %}
                                        <span class="badge bg-success">üì± WhatsApp</span>
                                    {% elif atendimento.forma_contato == 'Presencial' %}
                                        <span class="badge bg-info">üè¢ Presencial</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> Dados do Atendimento
                            </h6>

                            <div class="mb-3">
                                <label class="form-label text-muted">Produto:</label>
                                <div>
                                    <span class="badge bg-info fs-6">{{ atendimento.produto }}</span>
                                    {% if atendimento.marca %}
                                        <br><span class="text-muted">Marca: {{ atendimento.marca }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted">Respons√°vel:</label>
                                <div class="fw-bold">{{ atendimento.responsavel.nome }}</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted">Data/Hora In√≠cio:</label>
                                <div>
                                    <i class="bi bi-calendar"></i>
                                    {{ atendimento.data_inicio.strftime('%d/%m/%Y √†s %H:%M') }}
                                </div>
                            </div>

                            {% if atendimento.data_fim %}
                            <div class="mb-3">
                                <label class="form-label text-muted">Data/Hora Fim:</label>
                                <div>
                                    <i class="bi bi-calendar-check"></i>
                                    {{ atendimento.data_fim.strftime('%d/%m/%Y √†s %H:%M') }}
                                </div>
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label class="form-label text-muted">Dura√ß√£o:</label>
                                <div>
                                    <span class="badge {% if atendimento.status == 'em_andamento' %}bg-warning{% else %}bg-secondary{% endif %} fs-6">
                                        <i class="bi bi-stopwatch"></i> {{ atendimento.duracao }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Descri√ß√£o do Problema -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-file-text"></i> Descri√ß√£o do Problema
                    </h6>
                </div>
                <div class="card-body">
                    <div class="p-3 bg-light rounded">
                        {{ atendimento.problema | replace('\n', '<br>') | safe }}
                    </div>
                </div>
            </div>

            <!-- Observa√ß√µes -->
            {% if atendimento.observacoes %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-chat-left-text"></i> Observa√ß√µes Finais
                    </h6>
                </div>
                <div class="card-body">
                    <div class="p-3 bg-light rounded">
                        {{ atendimento.observacoes | replace('\n', '<br>') | safe }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Hist√≥rico de Logs -->
            {% if logs %}
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-clock-history"></i> Hist√≥rico do Atendimento
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for log in logs %}
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker">
                                    <i class="bi bi-circle-fill text-primary"></i>
                                </div>
                                <div class="timeline-content ms-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>{{ log.acao }}</strong>
                                            {% if log.detalhes %}
                                            <p class="mb-1 text-muted">{{ log.detalhes }}</p>
                                            {% endif %}
                                            <small class="text-muted">
                                                por {{ log.usuario.nome }}
                                            </small>
                                        </div>
                                        <small class="text-muted">
                                            {{ log.timestamp.strftime('%d/%m/%Y %H:%M') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- A√ß√µes r√°pidas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightning"></i> A√ß√µes R√°pidas
                    </h6>
                </div>
                <div class="card-body">
                    {% if atendimento.cliente_email %}
                    <a href="mailto:{{ atendimento.cliente_email }}" class="btn btn-outline-primary btn-sm mb-2 w-100">
                        <i class="bi bi-envelope"></i> Enviar Email
                    </a>
                    {% endif %}

                    {% if atendimento.cliente_contato %}
                    <a href="https://wa.me/{{ atendimento.cliente_contato.replace('(', '').replace(')', '').replace('-', '').replace(' ', '') }}"
                       target="_blank" class="btn btn-outline-success btn-sm mb-2 w-100">
                        <i class="bi bi-whatsapp"></i> WhatsApp
                    </a>
                    {% endif %}

                    <button onclick="window.print()" class="btn btn-outline-secondary btn-sm mb-2 w-100">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>

                    {% if current_user.role == 'admin' %}
                    <hr>
                    <button class="btn btn-outline-danger btn-sm w-100" onclick="cancelarAtendimento({{ atendimento.id }})">
                        <i class="bi bi-x-circle"></i> Cancelar Atendimento
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Informa√ß√µes complementares -->
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-info"></i> Informa√ß√µes Adicionais
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>ID do Atendimento:</strong><br>
                        <code>#{{ atendimento.id }}</code>
                    </div>

                    <div class="mb-3">
                        <strong>Produto em Atendimento:</strong><br>
                        <span class="badge bg-info">{{ atendimento.produto }}</span>
                    </div>

                    {% if atendimento.status == 'em_andamento' %}
                    <div class="alert alert-warning">
                        <i class="bi bi-clock"></i>
                        <strong>Atendimento em andamento</strong><br>
                        <small>Iniciado em {{ atendimento.data_inicio.strftime('%d/%m/%Y √†s %H:%M') }}</small>
                    </div>
                    {% elif atendimento.status == 'concluido' %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        <strong>Atendimento conclu√≠do</strong><br>
                        <small>Finalizado em {{ atendimento.data_fim.strftime('%d/%m/%Y √†s %H:%M') }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para transferir atendimento -->
<div class="modal fade" id="transferirModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-right-circle"></i> Transferir Atendimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transferirForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="novo_responsavel_id" class="form-label">Novo Respons√°vel <span class="text-danger">*</span></label>
                        <select class="form-select" id="novo_responsavel_id" name="novo_responsavel_id" required>
                            <option value="">Selecione o novo respons√°vel</option>
                            {% for usuario in usuarios %}
                            <option value="{{ usuario.id }}">{{ usuario.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo da transfer√™ncia (opcional)</label>
                        <textarea class="form-control" id="motivo" name="motivo" rows="3"
                                  placeholder="Descreva o motivo da transfer√™ncia (especializa√ß√£o, disponibilidade, etc.)"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Aten√ß√£o:</strong> O novo respons√°vel receber√° uma notifica√ß√£o sobre a transfer√™ncia e o hist√≥rico ser√° registrado.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-right-circle"></i> Transferir Atendimento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para finalizar atendimento -->
<div class="modal fade" id="finalizarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Finalizar Atendimento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="finalizarForm" method="POST">
                <div class="modal-body">
                    <p>Tem certeza que deseja finalizar este atendimento?</p>
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observa√ß√µes finais (opcional)</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="4"
                                  placeholder="Adicione observa√ß√µes sobre a resolu√ß√£o do problema, produtos utilizados, pr√≥ximos passos, etc..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Finalizar Atendimento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline-marker {
    min-width: 20px;
}

.timeline-item:not(:last-child) .timeline-content {
    border-left: 2px solid #e9ecef;
    padding-bottom: 20px;
    margin-left: 8px;
}

@media print {
    .btn, .navbar, .modal, footer {
        display: none !important;
    }
    .card {
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function transferirAtendimento(id) {
    const modal = new bootstrap.Modal(document.getElementById('transferirModal'));
    const form = document.getElementById('transferirForm');
    form.action = `/atendimentos/${id}/transferir`;
    modal.show();
}

function finalizarAtendimento(id) {
    const modal = new bootstrap.Modal(document.getElementById('finalizarModal'));
    const form = document.getElementById('finalizarForm');
    form.action = `/atendimentos/${id}/finalizar`;
    modal.show();
}

function cancelarAtendimento(id) {
    if (confirm('Tem certeza que deseja cancelar este atendimento? Esta a√ß√£o n√£o pode ser desfeita.')) {
        // Implementar cancelamento
        alert('Funcionalidade de cancelamento ser√° implementada.');
    }
}

// Auto-refresh do status se estiver em andamento
{% if atendimento.status == 'em_andamento' %}
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 30000); // Refresh a cada 30 segundos
{% endif %}
</script>
{% endblock %}